<!DOCTYPE HTML>
<html>
<head>
<link rel="stylesheet" href="http://cdn.webix.com/edge/webix.css" type="text/css"> 
<script src="http://cdn.webix.com/edge/webix.js" type="text/javascript"></script>  
</head>
<script src="https://www.gstatic.com/firebasejs/3.4.0/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.4.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.4.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.4.0/firebase-database.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCoJ7jvBdsoPURJFGNffXuphimgoQgnmNU",
    authDomain: "sharedchecklists.firebaseapp.com",
    databaseURL: "https://sharedchecklists.firebaseio.com",
  };
  firebase.initializeApp(config);
</script>

<script src="//connect.facebook.net/en_US/sdk.js"></script>
<script>
var user = "";
var email = "";
var muser = null;
var database = null;

function authcallback() {
  database = firebase.database();
  fetchUser(email.replace(/\./g,','));
};

function fetchUser(email) {
  var furef = database.ref('users').child(email).once('value').then(
     function(snapshot) {
     	muser = snapshot.val();
     });
}

function fetchChecklist(checklistid, cb) {
   var clref = database.ref('checklists').child(checklistid).once('value').then(
      function(snapshot) {
         var checklist = snapshot.val();
         cb(checklist);
      });
}

var provider = new firebase.auth.FacebookAuthProvider();
provider.addScope('email');
firebase.auth().signInWithPopup(provider).then(function(result) {
  // This gives you a Facebook Access Token. You can use it to access the Facebook API.
  var token = result.credential.accessToken;
  // The signed-in user info.
  var user = result.user;
  // ...
  parent.user = user;
  parent.email = user.email;
  authcallback();
}).catch(function(error) {
  // Handle Errors here.
  var errorCode = error.code;
  var errorMessage = error.message;
  // The email of the user's account used.
  var email = error.email;
  // The firebase.auth.AuthCredential type that was used.
  var credential = error.credential;
  // ...
   alert("error:"+errorMessage);
});


</script>
<body>
<h1>Some day this will work!</h1>

<div id="box" style="width:800px;height:1600px;"></div>

<script type="text/javascript" charset="utf-8">

function sleep (time) {
  return new Promise((resolve) => setTimeout(resolve, time));
}

var checklist_names = [];
var checklists = [];
var tree = new webix.ui({ view:"tree", container:"box", data: []});

// Usage!
sleep(5000).then(() => {

for (var i = 0; i < muser.checklists.length; i++) {
   fetchChecklist(muser.checklists[i], function(checklist) {
   if (checklist != null) {
       checklists.push(checklist);
       tree.add({ id:checklist.checklist_name, value:checklist.checklist_name}, 0);
       var data_constructor = [];
       for (var j = 0; j < checklist.items.length; j++) {
          tree.add({value:checklist.items[j].label}, 0, checklist.checklist_name);
       }
       checklist_names.push(checklist.checklist_name);
       
    }
});
}

webix.ui({
  rows:[
    { view:"template", type:"header", template:"Sharedchecklist"},
{ view:"datatable",
  autoConfig:true,
  data:{ email: muser.email, checklists: muser.checklists.length
      } } ] });
   
tree.show(true, true);

})
</script>

</body>

</html>
