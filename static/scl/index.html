<!DOCTYPE HTML>
<html>
<head>
<link rel="stylesheet" href="http://cdn.webix.com/edge/webix.css" type="text/css"> 
<script src="http://cdn.webix.com/edge/webix.js" type="text/javascript"></script>  
</head>
<script src="https://www.gstatic.com/firebasejs/3.4.0/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.4.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.4.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.4.0/firebase-database.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCoJ7jvBdsoPURJFGNffXuphimgoQgnmNU",
    authDomain: "sharedchecklists.firebaseapp.com",
    databaseURL: "https://sharedchecklists.firebaseio.com",
  };
  firebase.initializeApp(config);
</script>

<script src="//connect.facebook.net/en_US/sdk.js"></script>
<script>
var user = "";
var email = "";
var muser = null;
var database = null;

function authcallback() {
  database = firebase.database();
  fetchUser(email.replace(/\./g,','));
};

function fetchUser(email) {
  var furef = database.ref('users').child(email).once('value').then(
     function(snapshot) {
     	muser = snapshot.val();
     });
}

function fetchChecklist(checklistid, cb) {
   var clref = database.ref('checklists').child(checklistid).once('value').then(
      function(snapshot) {
         var checklist = snapshot.val();
         cb(checklist);
      });
}

var provider = new firebase.auth.FacebookAuthProvider();
provider.addScope('email');
firebase.auth().signInWithPopup(provider).then(function(result) {
  // This gives you a Facebook Access Token. You can use it to access the Facebook API.
  var token = result.credential.accessToken;
  // The signed-in user info.
  var user = result.user;
  // ...
  parent.user = user;
  parent.email = user.email;
  authcallback();
}).catch(function(error) {
  // Handle Errors here.
  var errorCode = error.code;
  var errorMessage = error.message;
  // The email of the user's account used.
  var email = error.email;
  // The firebase.auth.AuthCredential type that was used.
  var credential = error.credential;
  // ...
   alert("error:"+errorMessage);
});


</script>
<body>
<h1>Some day this will work!</h1>
<div id="box" style="width:800px;height:800px;"></div>

<script type="text/javascript" charset="utf-8">

function sleep (time) {
  return new Promise((resolve) => setTimeout(resolve, time));
}

var checklist_names = [];
var checklists = [];
var tree = new webix.ui({ view:"tree",
   template:"{common.icon()} {common.checkbox()} {common.folder()} #value#", container:"box", data: []});

function findchecklist(cl_name) {
    for (var i = 0; i < checklists.length; i++) {
       if (checklists[i].checklist_name == cl_name)
            return checklists[i];
    }
    return null;
}

function findchecklistitem(cl, label) {
    for (var i = 0; i < cl.items.length; i++) {
       if (cl.items[i].label == label)
          return cl.items[i];
    }
    return null;
}

function checkitem(id) {
    var cl_parse = id.split(':');
    var checklist_name = cl_parse[0];
    var item = cl_parse[1];

    var cl = findchecklist(checklist_name);
    if (cl == null) {
      alert("couldn't find checklist:"+checklist_name);
      return;
    }
    var cl_item = findchecklistitem(cl, item);
    if (cl_item == null) {
       alert("couldn't find checklist item:"+item);
       return;
    }

    if (cl_item.checked && tree.isChecked(id)) {
       // value of ui corresponds to db, done!
       return;
    }

    if (cl_item.checked == false && tree.isChecked(id) == false) {
       // value of ui corresponds to db, done!
       return;
    }

    alert("time o hack the db");
}

// Usage!
sleep(5000).then(() => {

for (var i = 0; i < muser.checklists.length; i++) {
   fetchChecklist(muser.checklists[i], function(checklist) {
   if (checklist != null) {
       checklists.push(checklist);
       tree.add({ id:checklist.checklist_name, value:checklist.checklist_name}, 0);
       for (var j = 0; j < checklist.items.length; j++) {
          tree.add({id:checklist.checklist_name+":"+checklist.items[j].label, value:checklist.items[j].label}, 0, checklist.checklist_name);
          var checked = checklist.items[j].checked;
          if (checklist.items[j].checked) {
             tree.checkItem(checklist.checklist_name+":"+checklist.items[j].label);
          }
       }
       checklist_names.push(checklist.checklist_name);
       
    }
});
}
tree.attachEvent("onItemCheck", checkitem);

var table = new webix.ui({
  rows:[
    { view:"template", type:"header", template:"Sharedchecklist"     },
  { view:"datatable",
  autoConfig:true,
  data:{ email: muser.email, checklists: muser.checklists.length
      } } ] });

table.show(true, true);   
tree.show(true, true);

})
</script>

</body>

</html>
